<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Truth Serum — Decentralized Fact Checker</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; max-width: 980px; margin: 28px auto; padding: 0 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #ddd; border-radius:14px; padding:14px; margin-top:14px; }
    label { font-size: 13px; color:#555; display:block; margin: 10px 0 6px; }
    input, textarea { width: 100%; padding: 10px 12px; font-size: 15px; border: 1px solid #ddd; border-radius: 10px; }
    textarea { min-height: 110px; }
    button { padding: 10px 14px; font-size: 15px; cursor:pointer; border-radius: 10px; border:1px solid #ddd; background:#fff; }
    .muted { color:#666; font-size:13px; }
    .pill { display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:999px; font-size:13px; }
    pre { white-space:pre-wrap; word-break:break-word; background:#fafafa; border:1px solid #eee; padding:12px; border-radius:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 860px){ .grid { grid-template-columns: 1fr; } }
    .ok { border-color:#0a0; }
    .warn { border-color:#f90; }
    .bad { border-color:#d00; }
  </style>
</head>
<body>
  <h1>Truth Serum</h1>
  <p class="muted">
    Paste a link (news/tweet/article). The contract fetches the page, extracts candidate sources,
    and returns: <b>True / False / Misleading / Not enough data</b> + explanation + sources.
  </p>

  <div class="card">
    <h3 style="margin:0 0 6px;">Wallet (Burner)</h3>
    <p class="muted" style="margin-top:0;">
      This demo uses a local signing wallet via GenLayerJS <code>createAccount()</code>.
      (MetaMask integration is still under development in the SDK.) :contentReference[oaicite:4]{index=4}
    </p>

    <div class="grid">
      <div>
        <div class="row">
          <button id="btnCreate">Create New Wallet</button>
          <button id="btnForget">Forget Wallet</button>
        </div>

        <label>Private key (stored in localStorage!)</label>
        <input id="pk" placeholder="0x..." />

        <div class="row" style="margin-top:10px;">
          <button id="btnImport">Import / Use This Key</button>
          <span class="muted" id="walletStatus">No wallet loaded</span>
        </div>

        <label>Address</label>
        <input id="addr" readonly />
      </div>

      <div>
        <div class="card" style="margin-top:0;">
          <div class="muted">
            RPC endpoint (StudioNet):
            <div><code>https://studio.genlayer.com/api</code></div>
            <div style="margin-top:6px;">
              If transactions fail with “insufficient funds”, send some test GEN to your address on StudioNet.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 6px;">Run a Fact Check</h3>

    <label>URL</label>
    <input id="url" placeholder="https://..." />

    <div class="row" style="margin-top:10px;">
      <button id="btnVerify">Verify (on-chain)</button>
      <button id="btnRead">Read stored result</button>
      <button id="btnLast">Get last result</button>
    </div>

    <div class="muted" id="status" style="margin-top:10px;">—</div>

    <label style="margin-top:12px;">Tx hash</label>
    <input id="txhash" placeholder="0x..." />
    <div class="row" style="margin-top:10px;">
      <button id="btnLoadTx">Load tx debug</button>
    </div>
  </div>

  <div class="card" id="out" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <span class="pill" id="verdictPill">Verdict: —</span>
      </div>
      <span class="muted" id="txLine"></span>
    </div>

    <h3 style="margin:12px 0 6px;">Explanation</h3>
    <div id="explanation" class="muted">—</div>

    <h3 style="margin:12px 0 6px;">Sources</h3>
    <div id="sources" class="muted">—</div>

    <h3 style="margin:12px 0 6px;">Key claims</h3>
    <div id="claims" class="muted">—</div>

    <details style="margin-top:10px;">
      <summary>Raw JSON (contract return)</summary>
      <pre id="raw">—</pre>
    </details>

    <details style="margin-top:10px;">
      <summary>Debug: Transaction object</summary>
      <pre id="txDebug">—</pre>
    </details>
  </div>

  <script type="module">
    import { createClient, createAccount, generatePrivateKey } from "https://esm.sh/genlayer-js";
    import { studionet } from "https://esm.sh/genlayer-js/chains";
    import { TransactionStatus } from "https://esm.sh/genlayer-js/types";

    // === SET THIS ===
    const CONTRACT_ADDRESS = "0x2715f59C9E8AD07c9C788c7f9e3d4e9DccaB6BcD";

    const RPC_ENDPOINT = "https://studio.genlayer.com/api";

    const el = (id) => document.getElementById(id);
    const setStatus = (s) => el("status").textContent = s;

    let account = null;
    let client = null;

    function savePk(pk) { localStorage.setItem("truthserum_pk", pk); }
    function loadPk() { return localStorage.getItem("truthserum_pk"); }
    function clearPk() { localStorage.removeItem("truthserum_pk"); }

    async function ensureClient() {
      if (!account) throw new Error("No wallet loaded");
      if (!client) {
        // createClient supports custom endpoint & signing account :contentReference[oaicite:5]{index=5}
        client = createClient({
          chain: studionet,
          endpoint: RPC_ENDPOINT,
          account,
        });
        await client.initializeConsensusSmartContract();
      }
      return client;
    }

    function showResult(obj, raw, txHash = "") {
      el("out").style.display = "block";
      el("raw").textContent = raw || "—";
      el("txLine").textContent = txHash ? `tx: ${txHash}` : "";

      const verdict = obj?.verdict ?? "—";
      el("verdictPill").textContent = `Verdict: ${verdict}`;

      // color hint
      el("verdictPill").classList.remove("ok","warn","bad");
      const v = String(verdict).toLowerCase();
      if (v === "true") el("verdictPill").classList.add("ok");
      else if (v === "false") el("verdictPill").classList.add("bad");
      else if (v === "misleading") el("verdictPill").classList.add("warn");

      el("explanation").textContent = obj?.explanation ?? "—";

      const sources = Array.isArray(obj?.sources) ? obj.sources : [];
      el("sources").innerHTML = sources.length
        ? "<ul>" + sources.map(s => {
            const u = (s && s.url) ? s.url : "";
            const note = (s && s.note) ? s.note : "";
            const safeU = u.replaceAll('"', "&quot;");
            return `<li><a href="${safeU}" target="_blank" rel="noreferrer">${u}</a> <span class="muted">— ${note}</span></li>`;
          }).join("") + "</ul>"
        : "<span class='muted'>(no sources)</span>";

      const claims = Array.isArray(obj?.key_claims) ? obj.key_claims : [];
      el("claims").innerHTML = claims.length
        ? "<ol>" + claims.map(c => `<li>${String(c)}</li>`).join("") + "</ol>"
        : "<span class='muted'>(no claims)</span>";
    }

    function showParseError(raw, txHash = "") {
      el("out").style.display = "block";
      el("verdictPill").textContent = "Verdict: Parse error";
      el("explanation").textContent = "Contract output was not valid JSON. See Raw JSON below.";
      el("sources").textContent = "—";
      el("claims").textContent = "—";
      el("raw").textContent = raw || "(empty)";
      el("txLine").textContent = txHash ? `tx: ${txHash}` : "";
    }

    // ---- Wallet UI ----
    function refreshWalletUI() {
      el("addr").value = account?.address || "";
      el("walletStatus").textContent = account ? "Wallet loaded" : "No wallet loaded";
    }

    el("btnCreate").onclick = () => {
      const pk = generatePrivateKey();
      el("pk").value = pk;
      savePk(pk);
      account = createAccount(pk);
      client = null;
      refreshWalletUI();
      setStatus("New wallet created and stored in localStorage.");
    };

    el("btnImport").onclick = () => {
      const pk = el("pk").value.trim();
      if (!pk.startsWith("0x") || pk.length < 10) {
        alert("Please paste a valid hex private key starting with 0x");
        return;
      }
      savePk(pk);
      account = createAccount(pk);
      client = null;
      refreshWalletUI();
      setStatus("Wallet imported and stored in localStorage.");
    };

    el("btnForget").onclick = () => {
      clearPk();
      account = null;
      client = null;
      refreshWalletUI();
      setStatus("Wallet cleared.");
    };

    // Auto-load saved wallet
    (() => {
      const pk = loadPk();
      if (pk) {
        el("pk").value = pk;
        account = createAccount(pk);
        refreshWalletUI();
        setStatus("Loaded wallet from localStorage.");
      }
    })();

    // ---- Contract actions ----
    async function readAndRenderForUrl(url, txHash = "") {
      const c = await ensureClient();

      // 1) Try get(url)
      const raw = await c.readContract({
        address: CONTRACT_ADDRESS,
        functionName: "get",
        args: [url],
      });

      if (raw && String(raw).trim().length) {
        try {
          const obj = JSON.parse(raw);
          showResult(obj, raw, txHash);
          return;
        } catch {
          showParseError(raw, txHash);
          return;
        }
      }

      // 2) Fallback: get_last()
      const last = await c.readContract({
        address: CONTRACT_ADDRESS,
        functionName: "get_last",
        args: [],
      });

      const lastRaw = last?.result || "";
      if (lastRaw && String(lastRaw).trim().length) {
        try {
          const obj = JSON.parse(lastRaw);
          showResult(obj, lastRaw, txHash);
          return;
        } catch {
          showParseError(lastRaw, txHash);
          return;
        }
      }

      showParseError("(empty result from get(url) and get_last())", txHash);
    }

    el("btnVerify").onclick = async () => {
      const url = el("url").value.trim();
      if (!url.startsWith("http://") && !url.startsWith("https://")) {
        alert("Please enter a valid URL starting with http:// or https://");
        return;
      }
      if (!CONTRACT_ADDRESS.startsWith("0x")) {
        alert("Set CONTRACT_ADDRESS in the HTML file.");
        return;
      }

      setStatus("Submitting verify(url) transaction…");
      const c = await ensureClient();

      try {
        // Your contract signature is verify(url: str) -> str (ONE argument)
        const txHash = await c.writeContract({
          address: CONTRACT_ADDRESS,
          functionName: "verify",
          args: [url],
          value: 0n,
        });

        el("txhash").value = txHash;

        setStatus("Waiting for FINALIZED…");
        await c.waitForTransactionReceipt({
          hash: txHash,
          status: TransactionStatus.FINALIZED,
          retries: 200,
          interval: 3000,
          fullTransaction: false,
        });

        setStatus("FINALIZED. Reading stored result…");
        await readAndRenderForUrl(url, txHash);

        setStatus("Done.");
      } catch (e) {
        console.error(e);
        setStatus("Error: " + (e?.message || String(e)));
      }
    };

    el("btnRead").onclick = async () => {
      const url = el("url").value.trim();
      if (!url) return alert("Enter a URL first.");
      setStatus("Reading get(url)…");
      try {
        await readAndRenderForUrl(url);
        setStatus("Done.");
      } catch (e) {
        console.error(e);
        setStatus("Error: " + (e?.message || String(e)));
      }
    };

    el("btnLast").onclick = async () => {
      setStatus("Reading get_last()…");
      try {
        const c = await ensureClient();
        const last = await c.readContract({
          address: CONTRACT_ADDRESS,
          functionName: "get_last",
          args: [],
        });
        const raw = last?.result || "";
        if (!raw) {
          showParseError("(empty get_last().result)");
          setStatus("Done.");
          return;
        }
        try {
          const obj = JSON.parse(raw);
          showResult(obj, raw);
        } catch {
          showParseError(raw);
        }
        setStatus("Done.");
      } catch (e) {
        console.error(e);
        setStatus("Error: " + (e?.message || String(e)));
      }
    };

    // ---- Tx debug ----
    el("btnLoadTx").onclick = async () => {
      const txHash = el("txhash").value.trim();
      if (!txHash.startsWith("0x")) return alert("Paste a tx hash.");
      setStatus("Loading transaction object…");
      try {
        const c = await ensureClient();
        const txObj = await c.getTransaction({ hash: txHash });
        el("txDebug").textContent = JSON.stringify(txObj, null, 2);
        setStatus("Tx loaded.");
      } catch (e) {
        console.error(e);
        setStatus("Error: " + (e?.message || String(e)));
      }
    };
  </script>
</body>
</html>
